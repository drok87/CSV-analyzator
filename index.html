<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Analyz√°tor Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover {
            border-color: #764ba2;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .upload-text {
            font-size: 1.4em;
            margin-bottom: 15px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .upload-subtext {
            color: #666;
            margin-bottom: 15px;
        }
        
        .upload-hint {
            font-size: 0.9em;
            color: #999;
        }
        
        .tabs {
            display: none;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
        }
        
        .tabs.active {
            display: flex;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
            border: none;
            background: none;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        
        input, select, button {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .export-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .danger-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            padding: 15px 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Styl pro OK hodnoty - zelen√© */
        .ok-value {
            color: #28a745;
            font-weight: bold;
            background-color: #d4edda;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .data-insights {
            background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ CSV Analyz√°tor Pro</h1>
            <div class="subtitle">Pokroƒçil√Ω n√°stroj pro anal√Ωzu CSV dat</div>
        </div>
        
        <div class="main-content">
            <div id="uploadSection">
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">P≈ôet√°hnƒõte soubory nebo kliknƒõte pro v√Ωbƒõr</div>
                    <div class="upload-subtext">Podporovan√© form√°ty: CSV, TSV, Excel (.xlsx, .xls)</div>
                    <div class="upload-hint">Auto-detekce form√°tu a inteligentn√≠ doporuƒçen√≠ graf≈Ø</div>
                    <input type="file" id="fileInput" style="display: none;" accept=".csv,.tsv,.xlsx,.xls" onchange="handleFileUpload(event)">
                </div>
            </div>
            
            <div id="dataSection" class="hidden">
                <div class="tabs" id="tabsContainer">
                    <button class="tab active" onclick="switchTab('overview')">üìã P≈ôehled</button>
                    <button class="tab" onclick="switchTab('table')">üìä Tabulka</button>
                    <button class="tab" onclick="switchTab('charts')">üìà Grafy</button>
                    <button class="tab" onclick="switchTab('tools')">üõ†Ô∏è N√°stroje</button>
                </div>
                
                <div id="overview" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRecords">0</div>
                            <div>Celkem z√°znam≈Ø</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalColumns">0</div>
                            <div>Poƒçet sloupc≈Ø</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="fileSize">0 KB</div>
                            <div>Velikost souboru</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="dataQuality">0%</div>
                            <div>Kvalita dat</div>
                        </div>
                    </div>
                    
                    <div class="data-insights">
                        <h3>üß† AI Automatick√° anal√Ωza</h3>
                        <div id="autoInsights">
                            <div class="insight-item">
                                <span>üí°</span>
                                <span>Nahrajte CSV soubor pro automatickou AI anal√Ωzu</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üìä Detekovan√© typy dat</h3>
                        <div id="dataTypes">Po nahr√°n√≠ souboru se zde zobraz√≠ anal√Ωza typ≈Ø dat</div>
                    </div>
                </div>
                
                <div id="table" class="tab-content">
                    <div class="controls">
                        <label>üîç Hledat:</label>
                        <input type="text" id="quickSearch" placeholder="Zadejte text...">
                        
                        <label>Z√°znam≈Ø na str√°nku:</label>
                        <select id="recordsPerPage">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                        
                        <button onclick="exportToExcel()" class="export-btn">üìä Export Excel</button>
                        <button onclick="clearData()" class="danger-btn">üóëÔ∏è Nov√Ω soubor</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table id="dataTable">
                                <thead id="tableHead"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="pagination">
                        <button onclick="changePage(-1)">‚Üê P≈ôedchoz√≠</button>
                        <span id="pageInfo">Str√°nka 1 z 1</span>
                        <button onclick="changePage(1)">Dal≈°√≠ ‚Üí</button>
                    </div>
                </div>
                
                <div id="charts" class="tab-content">
                    <div class="controls">
                        <label>Typ grafu:</label>
                        <select id="chartType" onchange="updateChart()">
                            <option value="bar">üìä Sloupcov√Ω</option>
                            <option value="line">üìà ƒå√°rov√Ω</option>
                            <option value="pie">ü•ß Kruhov√Ω</option>
                            <option value="doughnut">üç© Kobliha</option>
                        </select>
                        
                        <label>X osa (ƒças/kategorie):</label>
                        <select id="chartXAxis" onchange="updateChart()"></select>
                        
                        <label>Y osy (hodnoty k porovn√°n√≠):</label>
                        <div id="yAxisContainer" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <select id="chartYAxis1" onchange="updateChart()">
                                <option value="">Vyberte prvn√≠ hodnotu</option>
                            </select>
                            <select id="chartYAxis2" onchange="updateChart()">
                                <option value="">Vyberte druhou hodnotu (voliteln√©)</option>
                            </select>
                            <select id="chartYAxis3" onchange="updateChart()">
                                <option value="">Vyberte t≈ôet√≠ hodnotu (voliteln√©)</option>
                            </select>
                            <button type="button" onclick="addYAxis()" style="padding: 8px 12px; font-size: 12px;">‚ûï P≈ôidat hodnotu</button>
                        </div>
                        
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px; padding: 15px; background: #e8f4fd; border-radius: 8px;">
                            <label>üìÖ ƒåasov√© obdob√≠:</label>
                            <label>Od:</label>
                            <input type="datetime-local" id="dateFrom" onchange="updateChart()" style="font-size: 12px;">
                            <label>Do:</label>
                            <input type="datetime-local" id="dateTo" onchange="updateChart()" style="font-size: 12px;">
                            <button type="button" onclick="resetDateRange()" style="padding: 6px 12px; font-size: 12px; background: #ffc107; color: #000;">üîÑ Resetovat</button>
                            <button type="button" onclick="setQuickRange('today')" style="padding: 6px 12px; font-size: 12px;">üìÖ Dnes</button>
                            <button type="button" onclick="setQuickRange('week')" style="padding: 6px 12px; font-size: 12px;">üìÖ T√Ωden</button>
                            <button type="button" onclick="setQuickRange('month')" style="padding: 6px 12px; font-size: 12px;">üìÖ Mƒõs√≠c</button>
                        </div>
                        
                        <label>Poƒçet z√°znam≈Ø (p≈ôi neomezen√©m obdob√≠):</label>
                        <select id="chartDataLimit" onchange="updateChart()">
                            <option value="50">50 posledn√≠ch</option>
                            <option value="100">100 posledn√≠ch</option>
                            <option value="200">200 posledn√≠ch</option>
                            <option value="500">500 posledn√≠ch</option>
                            <option value="1000">1000 posledn√≠ch</option>
                            <option value="all">V≈°echny z√°znamy</option>
                        </select>
                        
                        <div style="margin-top: 10px;">
                            <label>
                                <input type="checkbox" id="smoothLines" onchange="updateChart()"> 
                                Vyhlazen√© k≈ôivky (pouze pro ƒç√°rov√© grafy)
                            </label>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="mainChart" width="800" height="400"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üìä Statistiky vybran√Ωch hodnot</h3>
                        <div id="chartStats">Vyberte hodnoty pro zobrazen√≠ statistik</div>
                    </div>
                </div>
                
                <div id="tools" class="tab-content">
                    <div class="controls">
                        <button onclick="removeDuplicates()">üóëÔ∏è Odstranit duplicity</button>
                        <button onclick="removeEmptyRows()">üì≠ Odstranit pr√°zdn√© ≈ô√°dky</button>
                        <button onclick="validateData()">‚úÖ Validovat data</button>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üîß V√Ωsledky operac√≠</h3>
                        <div id="toolsContent">Vyberte n√°stroj pro anal√Ωzu dat.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let recordsPerPage = 50;
        let columns = [];
        let fileName = '';
        let fileSize = 0;
        let charts = {};
        let dataTypes = {};
        let yAxisCounter = 3;

        // Mapov√°n√≠ anglick√Ωch n√°zv≈Ø sloupc≈Ø na ƒçesk√©
        const columnTranslations = {
            'Name': 'N√°zev',
            'Price': 'Cena',
            'Date': 'Datum',
            'Status': 'Stav',
            'Type': 'Typ',
            'Category': 'Kategorie',
            'Description': 'Popis',
            'Amount': 'Mno≈æstv√≠',
            'Quantity': 'Poƒçet',
            'ID': 'Identifik√°tor',
            'Email': 'E-mail',
            'Phone': 'Telefon',
            'Address': 'Adresa',
            'City': 'Mƒõsto',
            'Country': 'Zemƒõ',
            'Company': 'Spoleƒçnost',
            'Product': 'Produkt',
            'Order': 'Objedn√°vka',
            'Customer': 'Z√°kazn√≠k',
            'Sales': 'Prodeje',
            'Revenue': 'Tr≈æby',
            'Cost': 'N√°klady',
            'Profit': 'Zisk',
            'Region': 'Region',
            'Time': 'ƒåas',
            'Value': 'Hodnota',
            'Total': 'Celkem',
            'Average': 'Pr≈Ømƒõr',
            'Count': 'Poƒçet',
            'Sum': 'Souƒçet',
            'Min': 'Minimum',
            'Max': 'Maximum',
            'Active': 'Aktivn√≠',
            'Inactive': 'Neaktivn√≠',
            'Pending': 'ƒåekaj√≠c√≠',
            'Completed': 'Dokonƒçeno',
            'Failed': 'Selhalo',
            'Success': '√öspƒõch',
            'Error': 'Chyba',
            'Warning': 'Varov√°n√≠',
            'Info': 'Informace',
            'EAN': 'EAN k√≥d',
            'URL': 'URL adresa',
            'ResponseTime': 'Doba odezvy',
            'StatusCode': 'Stavov√Ω k√≥d',
            'Timestamp': 'ƒåasov√° znaƒçka',
            // Nov√© p≈ôeklady pro v√°≈° soubor
            'Datum': 'Datum',
            'Prostor 1 (Pb1) ¬∞C': 'Teplota prostoru 1 ¬∞C',
            'Dve≈ôn√≠ sp√≠naƒç': 'Dve≈ôn√≠ sp√≠naƒç',
            'Bez linky': 'Bez linky',
            'Odt√°v√°n√≠': 'Odt√°v√°n√≠',
            'V√Ωparn√≠k (Pb2) ¬∞C': 'Teplota v√Ωparn√≠ku ¬∞C',
            'Vetil√°tory': 'Ventil√°tory',
            'Alarm': 'Alarm',
            'Chlazen√≠': 'Chlazen√≠',
            'Zapnuto': 'Zapnuto',
            'Prostor 2 (Pb3) ¬∞C': 'Teplota prostoru 2 ¬∞C',
            'Kl√°vesnice': 'Kl√°vesnice',
            'N√≠zk√° teplota - sonda Pb1': 'N√≠zk√° teplota - sonda 1',
            'Vysok√° teplota - sonda Pb1': 'Vysok√° teplota - sonda 1',
            'Chyba sondy Pb1': 'Chyba sondy 1',
            'Chyba sondy Pb2': 'Chyba sondy 2',
            '≈Ω√°dan√° teplota ¬∞C': '≈Ω√°dan√° teplota ¬∞C',
            'Chyba sondy Pb3': 'Chyba sondy 3',
            'Otev≈ôen√© dve≈ôe': 'Otev≈ôen√© dve≈ôe',
            'Chyba RTC': 'Chyba RTC',
            'Chyba EEPROM': 'Chyba EEPROM'
        };

        function translateColumnName(originalName) {
            return columnTranslations[originalName] || originalName;
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function processFile(file) {
            fileName = file.name;
            fileSize = file.size;
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                processExcelFile(file);
            } else {
                processCSVFile(file);
            }
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length > 0) {
                        const originalColumns = jsonData[0].map(col => col || 'Sloupec');
                        columns = originalColumns.map(col => translateColumnName(col));
                        
                        allData = jsonData.slice(1).map(row => {
                            const obj = {};
                            columns.forEach((col, index) => {
                                obj[col] = row[index] || '';
                            });
                            return obj;
                        });
                        
                        initializeApp();
                    }
                } catch (error) {
                    showMessage('Chyba p≈ôi ƒçten√≠ Excel souboru: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    
                    if (csvContent.includes(';') && csvContent.includes(':') && csvContent.includes('EAN:')) {
                        parseRohlikFormat(csvContent);
                    } else {
                        parseStandardCSV(csvContent);
                    }
                } catch (error) {
                    showMessage('Chyba p≈ôi ƒçten√≠ CSV souboru: ' + error.message);
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        function parseStandardCSV(csvContent) {
            // Detekce speci√°ln√≠ho form√°tu s extra uvozovkami
            const lines = csvContent.split('\n');
            let processedContent = csvContent;
            
            // Pokud prvn√≠ ≈ô√°dek obsahuje pouze n√°zev bez ƒç√°rek, p≈ôeskoƒç√≠me ho
            if (lines.length > 1 && lines[0].includes('"') && !lines[0].includes(',')) {
                processedContent = lines.slice(1).join('\n');
            }
            
            // Odstranƒõn√≠ zdvojen√Ωch uvozovek na zaƒç√°tku a konci ≈ô√°dk≈Ø
            if (processedContent.includes('""')) {
                const cleanedLines = processedContent.split('\n').map(line => {
                    if (line.startsWith('""') && line.endsWith('""')) {
                        return line.slice(2, -2);
                    }
                    return line;
                });
                processedContent = cleanedLines.join('\n');
            }
            
            Papa.parse(processedContent, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                delimitersToGuess: [',', '\t', '|', ';'],
                complete: function(results) {
                    allData = results.data.filter(row => 
                        Object.values(row).some(val => val !== null && val !== undefined && val !== '')
                    );
                    
                    const originalFields = results.meta.fields || [];
                    columns = originalFields.map(field => translateColumnName(field));
                    
                    allData = allData.map(row => {
                        const newRow = {};
                        originalFields.forEach((originalField, index) => {
                            const translatedField = columns[index];
                            newRow[translatedField] = row[originalField];
                        });
                        return newRow;
                    });
                    
                    initializeApp();
                }
            });
        }

        function initializeApp() {
            filteredData = [...allData];
            
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dataSection').classList.remove('hidden');
            document.getElementById('tabsContainer').classList.add('active');
            
            analyzeDataTypes();
            updateStats();
            initializeSelects();
            initializeDateRange();
            renderTable();
            
            showMessage(`‚úÖ √öspƒõ≈°nƒõ naƒçteno ${allData.length.toLocaleString()} z√°znam≈Ø!`);
        }

        function analyzeDataTypes() {
            dataTypes = {};
            
            columns.forEach(col => {
                const values = allData.map(row => row[col]).filter(val => val !== null && val !== undefined && val !== '');
                if (values.length === 0) {
                    dataTypes[col] = 'empty';
                    return;
                }
                
                const sample = values.slice(0, Math.min(100, values.length));
                const numberCount = sample.filter(val => !isNaN(val) && !isNaN(parseFloat(val))).length;
                const numberRatio = numberCount / sample.length;
                
                if (numberRatio > 0.8) {
                    dataTypes[col] = 'number';
                } else {
                    const uniqueRatio = new Set(sample).size / sample.length;
                    if (uniqueRatio < 0.1) {
                        dataTypes[col] = 'category';
                    } else {
                        dataTypes[col] = 'text';
                    }
                }
            });
            
            displayDataTypes();
            generateAutoInsights();
        }

        function displayDataTypes() {
            const typeIcons = {
                'number': 'üî¢',
                'category': 'üè∑Ô∏è',
                'text': 'üìù',
                'empty': '‚ùå'
            };
            
            const typeNames = {
                'number': 'ƒç√≠seln√Ω',
                'category': 'kategorie',
                'text': 'textov√Ω',
                'empty': 'pr√°zdn√Ω'
            };
            
            const html = columns.map(col => {
                const type = dataTypes[col];
                const values = allData.map(row => row[col]).filter(val => val !== null && val !== undefined && val !== '');
                const uniqueCount = new Set(values).size;
                
                return `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${typeIcons[type]} ${col}</strong> (${typeNames[type]})<br>
                        <small>Unik√°tn√≠ hodnoty: ${uniqueCount}</small>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dataTypes').innerHTML = html;
        }

        function generateAutoInsights() {
            const insights = [];
            
            const duplicates = findDuplicates();
            if (duplicates.length > 0) {
                insights.push(`üîÑ Nalezeno ${duplicates.length} duplicitn√≠ch z√°znam≈Ø`);
            }
            
            const emptyColumns = columns.filter(col => {
                const emptyCount = allData.filter(row => !row[col] || row[col] === '').length;
                return emptyCount > allData.length * 0.5;
            });
            
            if (emptyColumns.length > 0) {
                insights.push(`‚ö†Ô∏è Sloupce s v√≠ce ne≈æ 50% pr√°zdn√Ωch hodnot: ${emptyColumns.join(', ')}`);
            }
            
            if (insights.length === 0) {
                insights.push('‚úÖ Data vypadaj√≠ kvalitnƒõ bez zjevn√Ωch probl√©m≈Ø!');
            }
            
            const html = insights.map(insight => `
                <div class="insight-item">
                    <span>${insight}</span>
                </div>
            `).join('');
            
            document.getElementById('autoInsights').innerHTML = html;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'charts') {
                setTimeout(updateChart, 100);
            }
        }

        function updateStats() {
            document.getElementById('totalRecords').textContent = allData.length.toLocaleString();
            document.getElementById('totalColumns').textContent = columns.length;
            document.getElementById('fileSize').textContent = formatFileSize(fileSize);
            
            const totalCells = allData.length * columns.length;
            const emptyCells = allData.reduce((sum, row) => {
                return sum + columns.filter(col => !row[col] || row[col] === '').length;
            }, 0);
            const quality = Math.round(((totalCells - emptyCells) / totalCells) * 100);
            document.getElementById('dataQuality').textContent = quality + '%';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function initializeSelects() {
            const yAxisSelects = ['chartYAxis1', 'chartYAxis2', 'chartYAxis3'];
            const xAxisSelect = ['chartXAxis'];
            const allSelects = [...xAxisSelect, ...yAxisSelects];
            
            allSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const isYAxis = yAxisSelects.includes(selectId);
                    const placeholder = isYAxis ? 'Vyberte hodnotu' : 'Vyberte sloupec';
                    
                    select.innerHTML = `<option value="">${placeholder}</option>` +
                        columns.map(col => `<option value="${col}">${col}</option>`).join('');
                }
            });
        }

        function initializeDateRange() {
            const dateColumn = findDateColumn();
            if (!dateColumn) return;
            
            const dates = allData.map(row => parseDate(row[dateColumn])).filter(d => d);
            if (dates.length === 0) return;
            
            dates.sort((a, b) => a - b);
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            
            if (dateFrom && dateTo) {
                dateFrom.value = formatDateForInput(minDate);
                dateTo.value = formatDateForInput(maxDate);
            }
        }

        function findDateColumn() {
            const dateKeywords = ['datum', 'date', 'time', 'ƒças', 'timestamp'];
            
            for (const col of columns) {
                const lowerCol = col.toLowerCase();
                if (dateKeywords.some(keyword => lowerCol.includes(keyword))) {
                    return col;
                }
            }
            
            return columns[0];
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            
            const str = dateString.toString().trim();
            
            // European format DD/MM/YYYY
            const match1 = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})$/);
            if (match1) {
                const [, day, month, year, hour, minute, second] = match1;
                return new Date(year, month - 1, day, hour, minute, second);
            }
            
            // ISO format
            const match2 = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{1,2}):(\d{1,2})$/);
            if (match2) {
                const [, year, month, day, hour, minute, second] = match2;
                return new Date(year, month - 1, day, hour, minute, second);
            }
            
            const parsed = new Date(str);
            if (!isNaN(parsed.getTime())) {
                return parsed;
            }
            
            return null;
        }

        function formatDateForInput(date) {
            if (!date) return '';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function resetDateRange() {
            initializeDateRange();
            updateChart();
        }

        function setQuickRange(range) {
            const now = new Date();
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            
            if (!dateFrom || !dateTo) return;
            
            let fromDate;
            
            switch (range) {
                case 'today':
                    fromDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    fromDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    return;
            }
            
            dateFrom.value = formatDateForInput(fromDate);
            dateTo.value = formatDateForInput(now);
            updateChart();
        }

        function filterDataByDateRange(data) {
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            
            if (!dateFrom || !dateTo || !dateFrom.value || !dateTo.value) {
                return data;
            }
            
            const fromDate = new Date(dateFrom.value);
            const toDate = new Date(dateTo.value);
            const dateColumn = findDateColumn();
            
            if (!dateColumn) return data;
            
            return data.filter(row => {
                const rowDate = parseDate(row[dateColumn]);
                if (!rowDate) return false;
                
                return rowDate >= fromDate && rowDate <= toDate;
            });
        }

        function addYAxis() {
            yAxisCounter++;
            const container = document.getElementById('yAxisContainer');
            const newSelect = document.createElement('select');
            newSelect.id = `chartYAxis${yAxisCounter}`;
            newSelect.onchange = updateChart;
            newSelect.innerHTML = '<option value="">Vyberte dal≈°√≠ hodnotu (voliteln√©)</option>' +
                columns.map(col => `<option value="${col}">${col}</option>`).join('');
            
            const addButton = container.querySelector('button');
            container.insertBefore(newSelect, addButton);
        }

        function getSelectedYAxes() {
            const yAxes = [];
            let counter = 1;
            
            while (true) {
                const select = document.getElementById(`chartYAxis${counter}`);
                if (!select) break;
                
                if (select.value) {
                    yAxes.push(select.value);
                }
                counter++;
            }
            
            return yAxes;
        }

        function generateChartColors(count) {
            const colors = [
                { bg: 'rgba(102, 126, 234, 0.2)', border: 'rgba(102, 126, 234, 1)' },
                { bg: 'rgba(255, 99, 132, 0.2)', border: 'rgba(255, 99, 132, 1)' },
                { bg: 'rgba(54, 162, 235, 0.2)', border: 'rgba(54, 162, 235, 1)' },
                { bg: 'rgba(255, 206, 86, 0.2)', border: 'rgba(255, 206, 86, 1)' },
                { bg: 'rgba(75, 192, 192, 0.2)', border: 'rgba(75, 192, 192, 1)' },
                { bg: 'rgba(153, 102, 255, 0.2)', border: 'rgba(153, 102, 255, 1)' },
                { bg: 'rgba(255, 159, 64, 0.2)', border: 'rgba(255, 159, 64, 1)' },
                { bg: 'rgba(199, 199, 199, 0.2)', border: 'rgba(199, 199, 199, 1)' }
            ];
            
            return colors.slice(0, count);
        }

        function calculateStats(data, columns) {
            const stats = {};
            
            columns.forEach(col => {
                const values = data.map(row => parseFloat(row[col])).filter(val => !isNaN(val));
                
                if (values.length > 0) {
                    const sum = values.reduce((a, b) => a + b, 0);
                    const avg = sum / values.length;
                    const min = Math.min(...values);
                    const max = Math.max(...values);
                    const median = values.sort((a, b) => a - b)[Math.floor(values.length / 2)];
                    
                    stats[col] = {
                        count: values.length,
                        sum: sum.toFixed(2),
                        average: avg.toFixed(2),
                        min: min.toFixed(2),
                        max: max.toFixed(2),
                        median: median.toFixed(2)
                    };
                }
            });
            
            return stats;
        }

        function isOkValue(value) {
            if (!value) return false;
            const normalizedValue = value.toString().toLowerCase().trim();
            return normalizedValue === 'ok' || normalizedValue === 'Ok' || normalizedValue === 'OK';
        }

        function renderTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            if (!thead || !tbody) return;
            
            thead.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
            tbody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = columns.map(col => {
                    const value = row[col] || '';
                    const cellClass = isOkValue(value) ? 'ok-value' : '';
                    return `<td title="${value}" class="${cellClass}">${value}</td>`;
                }).join('');
                tbody.appendChild(tr);
            });
            
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            document.getElementById('pageInfo').textContent = `Str√°nka ${currentPage} z ${totalPages}`;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function updateChart() {
            const chartType = document.getElementById('chartType');
            const xAxis = document.getElementById('chartXAxis');
            const dataLimit = document.getElementById('chartDataLimit');
            const smoothLines = document.getElementById('smoothLines');
            
            if (!chartType || !xAxis || !xAxis.value) return;
            
            const selectedYAxes = getSelectedYAxes();
            if (selectedYAxes.length === 0) return;
            
            const ctx = document.getElementById('mainChart');
            if (!ctx) return;
            
            if (charts.main) {
                charts.main.destroy();
            }
            
            let data = filterDataByDateRange(filteredData);
            
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            const hasDateRange = dateFrom && dateTo && dateFrom.value && dateTo.value;
            
            if (!hasDateRange) {
                const limit = dataLimit.value === 'all' ? data.length : parseInt(dataLimit.value);
                data = data.slice(-limit);
            }
            
            const recordCount = data.length;
            const totalCount = filteredData.length;
            
            const labels = data.map(row => {
                const value = row[xAxis.value];
                if (typeof value === 'string' && value.length > 15) {
                    return value.substring(0, 15) + '...';
                }
                return value;
            });
            
            const colors = generateChartColors(selectedYAxes.length);
            
            const datasets = selectedYAxes.map((yAxis, index) => {
                const values = data.map(row => {
                    const val = row[yAxis];
                    return typeof val === 'number' ? val : parseFloat(val) || 0;
                });
                
                const color = colors[index] || colors[0];
                
                return {
                    label: yAxis,
                    data: values,
                    backgroundColor: color.bg,
                    borderColor: color.border,
                    borderWidth: 2,
                    fill: false,
                    tension: smoothLines && smoothLines.checked ? 0.4 : 0
                };
            });
            
            const finalDatasets = (['pie', 'doughnut'].includes(chartType.value)) ? [datasets[0]] : datasets;
            
            charts.main = new Chart(ctx, {
                type: chartType.value,
                data: {
                    labels: labels,
                    datasets: finalDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y || context.parsed}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: hasDateRange ? 
                                `Zobrazeno ${recordCount} z√°znam≈Ø z vybran√©ho obdob√≠` : 
                                `Zobrazeno ${recordCount} z ${totalCount} z√°znam≈Ø`
                        }
                    },
                    scales: chartType.value === 'pie' || chartType.value === 'doughnut' ? {} : {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: xAxis.value
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: selectedYAxes.join(', ')
                            }
                        }
                    }
                }
            });
            
            updateChartStats(data, selectedYAxes);
        }

        function updateChartStats(data, selectedColumns) {
            const statsContainer = document.getElementById('chartStats');
            if (!statsContainer || selectedColumns.length === 0) return;
            
            const stats = calculateStats(data, selectedColumns);
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            selectedColumns.forEach(col => {
                if (stats[col]) {
                    const stat = stats[col];
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <h4 style="margin-bottom: 10px; color: #333;">${col}</h4>
                            <div style="font-size: 13px; line-height: 1.5;">
                                <div><strong>Poƒçet:</strong> ${stat.count}</div>
                                <div><strong>Pr≈Ømƒõr:</strong> ${stat.average}</div>
                                <div><strong>Minimum:</strong> ${stat.min}</div>
                                <div><strong>Maximum:</strong> ${stat.max}</div>
                                <div><strong>Medi√°n:</strong> ${stat.median}</div>
                                <div><strong>Souƒçet:</strong> ${stat.sum}</div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            statsContainer.innerHTML = html;
        }

        function findDuplicates() {
            const seen = new Set();
            const duplicates = [];
            
            allData.forEach(row => {
                const key = JSON.stringify(row);
                if (seen.has(key)) {
                    duplicates.push(row);
                } else {
                    seen.add(key);
                }
            });
            
            return duplicates;
        }

        function removeDuplicates() {
            const originalLength = allData.length;
            const seen = new Set();
            
            allData = allData.filter(row => {
                const key = JSON.stringify(row);
                if (seen.has(key)) {
                    return false;
                } else {
                    seen.add(key);
                    return true;
                }
            });
            
            filteredData = [...allData];
            updateStats();
            renderTable();
            
            const removedCount = originalLength - allData.length;
            showToolResult(`üóëÔ∏è Odstranƒõno ${removedCount} duplicitn√≠ch z√°znam≈Ø.`);
        }

        function removeEmptyRows() {
            const originalLength = allData.length;
            
            allData = allData.filter(row => 
                Object.values(row).some(value => value !== null && value !== undefined && value !== '')
            );
            
            filteredData = [...allData];
            updateStats();
            renderTable();
            
            const removedCount = originalLength - allData.length;
            showToolResult(`üì≠ Odstranƒõno ${removedCount} pr√°zdn√Ωch ≈ô√°dk≈Ø.`);
        }

        function validateData() {
            const issues = [];
            
            columns.forEach(col => {
                const emptyCount = allData.filter(row => !row[col] || row[col] === '').length;
                if (emptyCount > 0) {
                    issues.push(`${col}: ${emptyCount} pr√°zdn√Ωch hodnot`);
                }
            });
            
            const result = issues.length > 0 ? 
                `Nalezen√© probl√©my:<br>${issues.join('<br>')}` :
                '‚úÖ V≈°echna data jsou validn√≠!';
            
            showToolResult(result);
        }

        function showToolResult(message) {
            document.getElementById('toolsContent').innerHTML = `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">${message}</div>`;
        }

        function exportToExcel() {
            if (!filteredData || filteredData.length === 0) {
                showMessage('≈Ω√°dn√° data k exportu.');
                return;
            }
            
            const exportData = filteredData.map(row => {
                const newRow = {};
                columns.forEach(col => {
                    newRow[col] = row[col] || '';
                });
                return newRow;
            });
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            
            const exportFileName = fileName.replace(/\.[^/.]+$/, '') + '_export.xlsx';
            XLSX.writeFile(wb, exportFileName);
            
            showMessage(`üìä Export dokonƒçen: ${exportFileName}`);
        }

        function clearData() {
            if (confirm('Opravdu chcete smazat v≈°echna data a nahr√°t nov√Ω soubor?')) {
                allData = [];
                filteredData = [];
                columns = [];
                fileName = '';
                fileSize = 0;
                currentPage = 1;
                dataTypes = {};
                
                Object.values(charts).forEach(chart => {
                    if (chart && chart.destroy) chart.destroy();
                });
                charts = {};
                
                document.getElementById('uploadSection').classList.remove('hidden');
                document.getElementById('dataSection').classList.add('hidden');
                document.getElementById('tabsContainer').classList.remove('active');
                document.getElementById('fileInput').value = '';
                
                document.querySelectorAll('.tab').forEach((tab, index) => {
                    tab.classList.toggle('active', index === 0);
                });
                document.querySelectorAll('.tab-content').forEach((content, index) => {
                    content.classList.toggle('active', index === 0);
                });
                
                showMessage('üóëÔ∏è Data byla smaz√°na. M≈Ø≈æete nahr√°t nov√Ω soubor.');
            }
        }

        function showMessage(message) {
            // Zkontroluj jestli u≈æ neexistuje zpr√°va se stejn√Ωm textem
            const existingMessages = document.querySelectorAll('.success-message');
            for (let msg of existingMessages) {
                if (msg.textContent.includes(message)) {
                    return; // Zpr√°va u≈æ existuje, nevytv√°≈ôej novou
                }
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.innerHTML = `<div style="display: flex; align-items: center; gap: 10px;">
                <span>${message}</span>
            </div>`;
            
            const container = document.querySelector('.main-content');
            container.insertBefore(messageDiv, container.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const quickSearch = document.getElementById('quickSearch');
            if (quickSearch) {
                quickSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    filteredData = allData.filter(row => {
                        if (searchTerm) {
                            return Object.values(row).some(value => 
                                value && value.toString().toLowerCase().includes(searchTerm)
                            );
                        }
                        return true;
                    });
                    
                    currentPage = 1;
                    renderTable();
                });
            }
            
            const recordsSelect = document.getElementById('recordsPerPage');
            if (recordsSelect) {
                recordsSelect.addEventListener('change', function() {
                    recordsPerPage = parseInt(this.value);
                    currentPage = 1;
                    renderTable();
                });
            }
        });
    </script>
</body>
</html>