<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Analyz√°tor Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --apple-blue: #007aff;
            --apple-light-gray: #f5f5f7;
            --apple-medium-gray: #e5e5ea;
            --apple-border-color: #d1d1d6;
            --apple-text-color: #1d1d1f;
            --apple-secondary-text-color: #6e6e73;
            --apple-red: #ff3b30;
            --apple-green: #34c759;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji';
            background-color: var(--apple-light-gray);
            color: var(--apple-text-color);
            min-height: 100vh;
            padding: 24px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            border: 1px solid var(--apple-border-color);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .header {
            background: white;
            color: var(--apple-text-color);
            padding: 40px 30px 20px 30px;
            text-align: center;
            border-bottom: 1px solid var(--apple-medium-gray);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2em;
            color: var(--apple-secondary-text-color);
        }
        
        .main-content {
            padding: 30px;
        }
        
        .upload-zone {
            border: 2px dashed var(--apple-medium-gray);
            border-radius: 16px;
            padding: 60px 20px;
            text-align: center;
            background-color: var(--apple-light-gray);
            margin-bottom: 30px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        .upload-zone:hover {
            background-color: #e9e9ed;
            border-color: var(--apple-blue);
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: none;
            color: var(--apple-blue);
        }
        
        .upload-text {
            font-size: 1.4em;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--apple-text-color);
        }
        
        .upload-subtext, .upload-hint {
            color: var(--apple-secondary-text-color);
            margin-bottom: 8px;
        }
        
        .tabs {
            display: none;
            margin-bottom: 30px;
            background: var(--apple-medium-gray);
            border-radius: 10px;
            padding: 4px;
        }
        
        .tabs.active {
            display: flex;
        }
        
        .tab {
            flex: 1;
            padding: 10px 15px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-weight: 500;
            color: var(--apple-secondary-text-color);
            border: none;
            background: none;
        }
        
        .tab.active {
            background: white;
            color: var(--apple-text-color);
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card, .chart-container, .table-container, .controls, .data-insights {
            background: white;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--apple-medium-gray);
            margin-bottom: 20px;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--apple-text-color);
        }

        .stat-card div:last-child {
            color: var(--apple-secondary-text-color);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .control-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .control-group h4 {
            width: 100%;
            margin-bottom: -5px;
            font-size: 1em;
            color: var(--apple-secondary-text-color);
            font-weight: 500;
        }

        input, select {
            padding: 10px 14px;
            border: 1px solid var(--apple-border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: #fcfcfd;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        
        button {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border: 1px solid transparent;
        }

        button:active {
            transform: scale(0.98);
        }

        button {
            background-color: var(--apple-medium-gray);
            color: var(--apple-text-color);
            border: 1px solid var(--apple-border-color);
        }
        button:hover {
            background-color: #dcdce1;
        }

        .export-btn {
            background-color: var(--apple-blue);
            color: white;
            border: none;
        }
        .export-btn:hover {
            background-color: #0070e0;
        }
        
        .danger-btn {
            background-color: white;
            color: var(--apple-red);
            border: 1px solid var(--apple-border-color);
        }
        .danger-btn:hover {
             background-color: var(--apple-light-gray);
             color: var(--apple-red);
        }
        
        .table-wrapper { overflow: auto; max-height: 600px; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background: white;
            color: var(--apple-secondary-text-color);
            font-weight: 600;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--apple-medium-gray);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--apple-medium-gray);
            white-space: nowrap;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ok-value {
            color: var(--apple-green);
            font-weight: 500;
            background-color: rgba(52, 199, 89, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        tr:hover { background-color: var(--apple-light-gray); }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
        }
        
        .hidden { display: none !important; }
        
        .data-insights { border-left: 4px solid var(--apple-blue); }
        
        h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 12px;
            background: var(--apple-light-gray);
            border-radius: 8px;
        }
        
        .success-message {
            background: rgba(52, 199, 89, 0.15);
            color: #1a833b;
            padding: 15px;
            border-radius: 12px;
            margin: -10px 0 20px 0;
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        #categoryFilterContainer {
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--apple-light-gray);
            border-radius: 8px;
            border: 1px solid var(--apple-border-color);
        }
        #categoryFilterContainer label {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-content { padding: 15px; }
            h1 { font-size: 2em; }
            .container, .stat-card, .chart-container, .table-container, .controls { border-radius: 16px; }

            .controls .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ CSV Analyz√°tor Pro</h1>
            <div class="subtitle">Pokroƒçil√Ω n√°stroj pro anal√Ωzu CSV dat</div>
        </div>
        
        <div class="main-content">
            <div id="uploadSection">
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">P≈ôet√°hnƒõte soubory nebo kliknƒõte pro v√Ωbƒõr</div>
                    <div class="upload-subtext">Podporovan√© form√°ty: CSV, TSV, Excel (.xlsx, .xls)</div>
                    <div class="upload-hint">Inteligentn√≠ anal√Ωza a doporuƒçen√≠ graf≈Ø</div>
                    <input type="file" id="fileInput" style="display: none;" accept=".csv,.tsv,.xlsx,.xls" onchange="handleFileUpload(event)">
                </div>
            </div>
            
            <div id="dataSection" class="hidden">
                <div class="tabs" id="tabsContainer">
                    <button class="tab active" onclick="switchTab('overview')">üìã P≈ôehled</button>
                    <button class="tab" onclick="switchTab('table')">üìä Tabulka</button>
                    <button class="tab" onclick="switchTab('charts')">üìà Grafy</button>
                    <button class="tab" onclick="switchTab('tools')">üõ†Ô∏è N√°stroje</button>
                </div>
                
                <div id="overview" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRecords">0</div>
                            <div>Celkem z√°znam≈Ø</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalColumns">0</div>
                            <div>Poƒçet sloupc≈Ø</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="fileSize">0 KB</div>
                            <div>Velikost souboru</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="dataQuality">0%</div>
                            <div>Kvalita dat</div>
                        </div>
                    </div>
                    
                    <div class="data-insights">
                        <h3>üß† Automatick√° anal√Ωza</h3>
                        <div id="autoInsights"></div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üìä Detekovan√© typy dat</h3>
                        <div id="dataTypes"></div>
                    </div>
                </div>
                
                <div id="table" class="tab-content">
                    <div class="controls">
                         <div class="control-group">
                            <label>üîç Hledat:</label>
                            <input type="text" id="quickSearch" placeholder="Zadejte text...">
                            <label>Z√°znam≈Ø na str√°nku:</label>
                            <select id="recordsPerPage">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                            <button onclick="exportToExcel()" class="export-btn">üìä Export Excel</button>
                            <button onclick="clearData()" class="danger-btn">üóëÔ∏è Nov√Ω soubor</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table id="dataTable">
                                <thead id="tableHead"></thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="pagination">
                        <button onclick="changePage(-1)">‚Üê P≈ôedchoz√≠</button>
                        <span id="pageInfo">Str√°nka 1 z 1</span>
                        <button onclick="changePage(1)">Dal≈°√≠ ‚Üí</button>
                    </div>
                </div>
                
                <div id="charts" class="tab-content">
                    <div class="controls">
                        <div class="control-group">
                            <h4>Krok 1: Co chcete analyzovat a mƒõ≈ôit?</h4>
                            <label for="chartXAxis">Kategorie/ƒåas (osa X):</label>
                            <select id="chartXAxis" onchange="handleXAxisChange()"></select>
                            <label for="chartYAxis1">Hodnota (osa Y):</label>
                            <select id="chartYAxis1" onchange="updateChart()"></select>
                            <select id="chartYAxis2" onchange="updateChart()"></select>
                            <select id="chartYAxis3" onchange="updateChart()"></select>
                        </div>
                        
                        <div class="control-group">
                            <h4>Krok 2: Jak to chcete zobrazit?</h4>
                             <label for="chartType">Typ grafu:</label>
                            <select id="chartType" onchange="handleChartTypeChange()">
                                <option value="bar">üìä Sloupcov√Ω</option>
                                <option value="line">üìà ƒå√°rov√Ω</option>
                                <option value="pie">ü•ß Kruhov√Ω</option>
                                <option value="doughnut">üç© Kobliha</option>
                            </select>
                            <label>
                                <input type="checkbox" id="smoothLines" onchange="updateChart()"> 
                                Vyhlazen√© k≈ôivky
                            </label>
                        </div>

                        <div class="control-group" id="filterGroup">
                             <h4>Krok 3: Up≈ôesnit data (Filtry)</h4>
                             <div id="categoryFilterContainer" class="hidden"></div>
                             <div id="dateFilterContainer">
                                <label>Filtrovat podle data:</label>
                                <input type="datetime-local" id="dateFrom" onchange="updateChart()">
                                <input type="datetime-local" id="dateTo" onchange="updateChart()">
                             </div>
                        </div>

                    </div>
                    
                    <div class="chart-container">
                        <canvas id="mainChart" width="800" height="400"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üìä Statistiky vybran√Ωch hodnot</h3>
                        <div id="chartStats"></div>
                    </div>
                </div>
                
                <div id="tools" class="tab-content">
                    <div class="controls">
                        <button onclick="removeDuplicates()">üóëÔ∏è Odstranit duplicity</button>
                        <button onclick="removeEmptyRows()">üì≠ Odstranit pr√°zdn√© ≈ô√°dky</button>
                        <button onclick="validateData()">‚úÖ Validovat data</button>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üîß V√Ωsledky operac√≠</h3>
                        <div id="toolsContent">Vyberte n√°stroj pro anal√Ωzu dat.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let recordsPerPage = 50;
        let columns = [];
        let fileName = '';
        let fileSize = 0;
        let charts = {};
        let dataTypes = {};

        const predefinedHeaders = [];
        
        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) processFile(files[0]);
        }

        function processFile(file) {
            fileName = file.name;
            fileSize = file.size;
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                processExcelFile(file);
            } else {
                processCSVFile(file);
            }
        }

        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    const headers = jsonData.length > 0 ? Object.keys(jsonData[0]) : [];
                    processData(jsonData, headers);
                } catch (error) {
                    showMessage('Chyba p≈ôi ƒçten√≠ Excel souboru: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processCSVFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => parseStandardCSV(e.target.result);
            reader.onerror = () => showMessage('Chyba p≈ôi ƒçten√≠ souboru.', 'error');
            reader.readAsText(file, 'utf-8');
        }

        function parseStandardCSV(csvContent) {
            const usePredefinedHeaders = predefinedHeaders && predefinedHeaders.length > 0;
            Papa.parse(csvContent, {
                header: !usePredefinedHeaders,
                dynamicTyping: true,
                skipEmptyLines: true,
                delimitersToGuess: [',', ';', '\t', '|'],
                complete: function(results) {
                    let rawData = results.data;
                    let headerFields = usePredefinedHeaders ? predefinedHeaders : (results.meta.fields || []);
                    if (usePredefinedHeaders && Array.isArray(rawData[0])) {
                        rawData = rawData.map(rowArray => {
                            const obj = {};
                            headerFields.forEach((header, index) => { obj[header] = rowArray[index]; });
                            return obj;
                        });
                    }
                    processData(rawData, headerFields);
                }
            });
        }
        
        function processData(data, headers) {
             allData = data.filter(row => 
                Object.values(row).some(val => val != null && val !== '')
            );
            columns = headers;
            initializeApp();
        }

        function initializeApp() {
            analyzeDataTypes();
            formatDatesInData();
            filteredData = [...allData];
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('dataSection').classList.remove('hidden');
            document.getElementById('tabsContainer').classList.add('active');
            updateStats();
            initializeChartSelects();
            renderTable();
            displayDataTypes();
            generateAutoInsights();
            showMessage(`‚úÖ √öspƒõ≈°nƒõ naƒçteno ${allData.length.toLocaleString()} z√°znam≈Ø!`);
            
            const xAxisSelect = document.getElementById('chartXAxis');
            const yAxisSelect = document.getElementById('chartYAxis1');
            if (xAxisSelect.options.length > 1) xAxisSelect.selectedIndex = 1;
            if (yAxisSelect.options.length > 1) yAxisSelect.selectedIndex = 1;
            if (xAxisSelect.value && yAxisSelect.value) handleXAxisChange();
        }
        
        function formatDatesInData() {
            const dateColumn = findDateColumn();
            if (!dateColumn) return;
            const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            allData.forEach(row => {
                const dateObject = parseDate(row[dateColumn]);
                if (dateObject) row[dateColumn] = dateObject.toLocaleString('cs-CZ', options);
            });
        }
        
        function analyzeDataTypes() {
            dataTypes = {};
            columns.forEach(col => {
                const values = allData.map(row => row[col]).filter(val => val != null && val !== '');
                if (values.length === 0) { 
                    dataTypes[col] = 'empty'; 
                    return; 
                }
                
                const numericCount = values.filter(v => {
                    const strVal = String(v).replace(',', '.');
                    return !isNaN(parseFloat(strVal)) && isFinite(strVal);
                }).length;
                
                if ((numericCount / values.length) > 0.8) {
                    dataTypes[col] = 'number';
                } else if (values.some(v => parseDate(v) !== null)) {
                     dataTypes[col] = 'date';
                } else {
                    dataTypes[col] = 'category';
                }
            });
        }

        function initializeChartSelects() {
            const xAxisSelect = document.getElementById('chartXAxis');
            const yAxisSelects = document.querySelectorAll('#chartYAxis1, #chartYAxis2, #chartYAxis3');
            
            const categoryAndDateCols = columns.filter(c => ['category', 'date'].includes(dataTypes[c]));
            const numericCols = columns.filter(c => dataTypes[c] === 'number');

            xAxisSelect.innerHTML = '<option value="">Vyberte...</option>' + categoryAndDateCols.map(c => `<option value="${c}">${c}</option>`).join('');
            yAxisSelects.forEach(sel => {
                sel.innerHTML = '<option value="">Vyberte...</option>' + numericCols.map(c => `<option value="${c}">${c}</option>`).join('');
            });

            handleChartTypeChange();
        }
        
        function handleChartTypeChange() {
            const chartType = document.getElementById('chartType').value;
            const yAxis2 = document.getElementById('chartYAxis2');
            const yAxis3 = document.getElementById('chartYAxis3');
            const showMultipleY = !['pie', 'doughnut'].includes(chartType);
            yAxis2.classList.toggle('hidden', !showMultipleY);
            yAxis3.classList.toggle('hidden', !showMultipleY);
            updateChart();
        }
        
        function handleXAxisChange() {
            updateCategoryFilter();
            updateChart();
        }
        
        function updateCategoryFilter() {
            const xAxisCol = document.getElementById('chartXAxis').value;
            const filterContainer = document.getElementById('categoryFilterContainer');
            if (!xAxisCol || dataTypes[xAxisCol] !== 'category') {
                filterContainer.classList.add('hidden');
                filterContainer.innerHTML = '';
                return;
            }
            
            const uniqueValues = [...new Set(allData.map(row => row[xAxisCol]))].sort();
            filterContainer.innerHTML = '<h4>Filtrovat kategorie:</h4>' + uniqueValues.map(val => `
                <label>
                    <input type="checkbox" class="category-filter-cb" value="${val}" onchange="updateChart()" checked>
                    ${val || '(Pr√°zdn√©)'}
                </label>
            `).join('');
            filterContainer.classList.remove('hidden');
        }

        function updateChart() {
            const chartType = document.getElementById('chartType').value;
            const xAxisCol = document.getElementById('chartXAxis').value;
            const selectedYAxes = Array.from(document.querySelectorAll('#chartYAxis1, #chartYAxis2, #chartYAxis3'))
                .map(sel => sel.value).filter(Boolean);

            const ctx = document.getElementById('mainChart');
            if (!ctx) return;
            if (charts.main) charts.main.destroy();
            
            if (!xAxisCol || selectedYAxes.length === 0) { return; }

            let data = filteredData;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            if (dateFrom && dateTo) {
                const from = new Date(dateFrom);
                const to = new Date(dateTo);
                const dateCol = findDateColumn();
                if (dateCol) {
                    data = data.filter(row => {
                        const rowDate = parseDate(row[dateCol]);
                        return rowDate && rowDate >= from && rowDate <= to;
                    });
                }
            }
            
            const categoryCheckboxes = document.querySelectorAll('.category-filter-cb:checked');
            if (document.getElementById('categoryFilterContainer').offsetParent !== null && categoryCheckboxes.length > 0) {
                const selectedCategories = Array.from(categoryCheckboxes).map(cb => cb.value);
                data = data.filter(row => selectedCategories.includes(String(row[xAxisCol])));
            }
            
            const labels = [...new Set(data.map(row => row[xAxisCol]))].sort();
            
            const datasets = selectedYAxes.map((yAxis, i) => {
                let chartData;
                 if (chartType === 'pie' || chartType === 'doughnut') {
                    chartData = labels.map(label => 
                        data.filter(row => row[xAxisCol] === label)
                            .reduce((sum, row) => sum + (parseFloat(String(row[yAxis]).replace(',','.')) || 0), 0)
                    );
                } else {
                    chartData = labels.map(label => {
                        const matchingRows = data.filter(row => row[xAxisCol] === label);
                        if (matchingRows.length === 0) return 0;
                        const sum = matchingRows.reduce((s, r) => s + (parseFloat(String(r[yAxis]).replace(',','.')) || 0), 0);
                        return sum / matchingRows.length;
                    });
                }
                const colors = generateChartColors( (chartType === 'pie' || chartType === 'doughnut') ? labels.length : selectedYAxes.length );
                const color = colors[i % colors.length];

                return {
                    label: yAxis,
                    data: chartData,
                    backgroundColor: (chartType === 'pie' || chartType === 'doughnut') ? colors.map(c=>c.bg) : color.bg,
                    borderColor: (chartType === 'pie' || chartType === 'doughnut') ? colors.map(c=>c.border) : color.border,
                    borderWidth: 2,
                    fill: chartType === 'line',
                    tension: document.getElementById('smoothLines').checked ? 0.4 : 0
                };
            });
            
            charts.main = new Chart(ctx, {
                type: chartType,
                data: { labels, datasets: (chartType === 'pie' || chartType === 'doughnut') ? [datasets[0]] : datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { title: { display: true, text: `Zobrazeno ${data.length} z√°znam≈Ø` } },
                    scales: (chartType === 'pie' || chartType === 'doughnut') ? {} : {
                        x: { title: { display: true, text: xAxisCol } },
                        y: { title: { display: true, text: 'Pr≈Ømƒõrn√° hodnota' } }
                    }
                }
            });
            updateChartStats(data, selectedYAxes);
        }
        
        function renderTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            if (!thead || !tbody) return;
            thead.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
            const frag = document.createDocumentFragment();
            const pageData = filteredData.slice((currentPage - 1) * recordsPerPage, currentPage * recordsPerPage);
            pageData.forEach(row => {
                const tr = frag.appendChild(document.createElement('tr'));
                tr.innerHTML = columns.map(col => `<td title="${row[col] || ''}" class="${isOkValue(row[col]) ? 'ok-value' : ''}">${row[col] || ''}</td>`).join('');
            });
            tbody.innerHTML = '';
            tbody.appendChild(frag);
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            document.getElementById('pageInfo').textContent = `Str√°nka ${currentPage} z ${totalPages || 1}`;
        }
        
        function updateStats() {
            document.getElementById('totalRecords').textContent = allData.length.toLocaleString();
            document.getElementById('totalColumns').textContent = columns.length;
            document.getElementById('fileSize').textContent = formatFileSize(fileSize);
            const totalCells = allData.length * columns.length;
            const emptyCells = allData.reduce((sum, row) => sum + Object.values(row).filter(v => v==null || v==='').length, 0);
            const quality = totalCells > 0 ? Math.round(((totalCells - emptyCells) / totalCells) * 100) : 100;
            document.getElementById('dataQuality').textContent = quality + '%';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
        }

        function findDateColumn() {
            for (const col of columns) {
                if (dataTypes[col] === 'date') return col;
            }
            return null;
        }

        function parseDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            let str = dateString.trim();
            const matchCustom = str.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
            if (matchCustom) {
                const [, year, month, day, hour, minute, second] = matchCustom;
                return new Date(year, month - 1, day, hour, minute, second);
            }
            if (str.includes('.') && str.includes(':') && str.includes(' ')) {
                str = str.replace(',', '');
                const parsed = new Date(str);
                if (!isNaN(parsed.getTime())) {
                    return parsed;
                }
            }
            return null;
        }

        function isOkValue(value) { return value?.toString().toLowerCase().trim() === 'ok'; }
        
        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }
        
        function updateChartStats(data, selectedColumns) {
            const statsContainer = document.getElementById('chartStats');
            if (!statsContainer || selectedColumns.length === 0) { statsContainer.innerHTML = 'Vyberte hodnoty pro zobrazen√≠ statistik.'; return; }
            const stats = calculateStats(data, selectedColumns);
            statsContainer.innerHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">' +
                selectedColumns.map(col => stats[col] ? `
                    <div style="background: var(--apple-light-gray); padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">${col}</h4>
                        <div style="font-size: 13px; line-height: 1.6; color: var(--apple-secondary-text-color);">${Object.entries(stats[col]).map(([key, value]) => `<div style="display: flex; justify-content: space-between;"><strong>${key}:</strong> ${value}</div>`).join('')}</div>
                    </div>` : '').join('') + '</div>';
        }

        function calculateStats(data, columns) {
            const stats = {};
            columns.forEach(col => {
                const values = data.map(row => parseFloat(String(row[col]).replace(',','.'))).filter(val => !isNaN(val));
                if (values.length > 0) {
                    const sum = values.reduce((a, b) => a + b, 0);
                    stats[col] = {
                        Poƒçet: values.length, Souƒçet: sum.toFixed(2), Pr≈Ømƒõr: (sum / values.length).toFixed(2),
                        Min: Math.min(...values).toFixed(2), Max: Math.max(...values).toFixed(2),
                        Medi√°n: values.sort((a,b)=>a-b)[Math.floor(values.length / 2)].toFixed(2)
                    };
                }
            });
            return stats;
        }
        
        function generateChartColors(count) {
            const baseColors = [
                { bg: 'rgba(0, 122, 255, 0.6)', border: 'rgba(0, 122, 255, 1)' }, { bg: 'rgba(52, 199, 89, 0.6)', border: 'rgba(52, 199, 89, 1)' },
                { bg: 'rgba(255, 149, 0, 0.6)', border: 'rgba(255, 149, 0, 1)' }, { bg: 'rgba(255, 59, 48, 0.6)', border: 'rgba(255, 59, 48, 1)' },
                { bg: 'rgba(175, 82, 222, 0.6)', border: 'rgba(175, 82, 222, 1)' }
            ];
            let colors = [];
            for (let i = 0; i < count; i++) colors.push(baseColors[i % baseColors.length]);
            return colors;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'charts') updateChart();
        }

        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            if (type === 'error') {
                messageDiv.style.backgroundColor = 'rgba(255, 59, 48, 0.15)';
                messageDiv.style.color = '#c50f0f';
            }
            messageDiv.innerHTML = `<span>${message}</span>`;
            const container = document.querySelector('.main-content');
            container.insertBefore(messageDiv, container.firstChild);
            setTimeout(() => messageDiv.remove(), 5000);
        }
        
        function displayDataTypes() {
            const container = document.getElementById('dataTypes');
            const typeIcons = { 'number': 'üî¢', 'category': 'üè∑Ô∏è', 'text': 'üìù', 'date': 'üìÖ', 'empty': '‚ùå' };
            const typeNames = { 'number': 'ƒå√≠slo', 'category': 'Kategorie', 'text': 'Text', 'date': 'Datum', 'empty': 'Pr√°zdn√Ω' };
            container.innerHTML = columns.map(col => `
                <div class="insight-item">
                    <span>${typeIcons[dataTypes[col]] || '‚ùì'} <strong>${col}</strong> <em style="color: var(--apple-secondary-text-color)">(${typeNames[dataTypes[col]] || 'Nezn√°m√Ω'})</em></span>
                </div>
            `).join('');
        }
        
        function generateAutoInsights() {
            const container = document.getElementById('autoInsights');
            const insights = [];
            const duplicates = allData.length - new Set(allData.map(row => JSON.stringify(row))).size;
            if (duplicates > 0) insights.push(`üîÑ Nalezeno ${duplicates} duplicitn√≠ch z√°znam≈Ø.`);
            
            const emptyCols = columns.filter(col => allData.every(row => row[col] == null || row[col] === ''));
            if (emptyCols.length > 0) insights.push(`üóëÔ∏è N√°sleduj√≠c√≠ sloupce jsou zcela pr√°zdn√©: ${emptyCols.join(', ')}.`);
            
            if (insights.length === 0) insights.push('‚úÖ Vypad√° to, ≈æe data jsou v dobr√© kondici. Nebyly nalezeny ≈æ√°dn√© zjevn√© probl√©my.');

            container.innerHTML = insights.map(insight => `<div class="insight-item"><span>${insight}</span></div>`).join('');
        }

        document.getElementById('quickSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filteredData = allData.filter(row => Object.values(row).some(val => val?.toString().toLowerCase().includes(searchTerm)));
            currentPage = 1;
            renderTable();
        });

        document.getElementById('recordsPerPage').addEventListener('change', function() {
            recordsPerPage = parseInt(this.value);
            currentPage = 1;
            renderTable();
        });

    </script>
</body>
</html>