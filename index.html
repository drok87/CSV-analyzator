<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktivn√≠ Data Analyz√°tor s ML</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --text-color: #000000;
            --secondary-text-color: #8E8E93;
            --container-bg: #ffffff;
            --header-bg: #ffffff;
            --tab-bg: #e9e9eb;
            --tab-active-bg: #ffffff;
            --primary-color: #007AFF;
            --primary-hover: #006ee6;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --border-color: #e5e5ea;
            --shadow-color: rgba(0,0,0,0.05);
            --radius: 12px;
        }

        .dark-mode {
            --bg-color: #000000;
            --text-color: #ffffff;
            --secondary-text-color: #8E8E93;
            --container-bg: #1C1C1E;
            --header-bg: #1C1C1E;
            --tab-bg: #2c2c2e;
            --tab-active-bg: #3a3a3c;
            --primary-color: #0A84FF;
            --primary-hover: #3593ff;
            --danger-color: #FF453A;
            --success-color: #30D158;
            --border-color: #38383a;
            --shadow-color: rgba(0,0,0,0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 10px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .header {
            background: var(--header-bg);
            color: var(--text-color);
            padding: 20px 30px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .header p {
            color: var(--secondary-text-color);
        }
        
        .theme-switcher {
            position: absolute;
            top: 20px;
            left: 20px;
            cursor: pointer;
            font-size: 1.5em;
        }

        #uploadNewFileBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #uploadNewFileBtn:hover {
            background: var(--primary-hover);
        }

        .upload-section { padding: 40px; text-align: center; }
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 20px;
            padding: 50px 20px;
            background: var(--bg-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-zone:hover { border-color: var(--primary-color); }
        .upload-icon { font-size: 3em; margin-bottom: 15px; }

        .data-section { display: none; padding: 20px; }
        .data-section.active { display: block; }

        .tabs {
            display: flex;
            background: var(--tab-bg);
            border-radius: var(--radius);
            padding: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1 1 auto;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        .tab.active {
            background: var(--tab-active-bg);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .widget {
            background: var(--container-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
            cursor: grab;
            transition: background-color 0.3s;
        }
        .widget:active { cursor: grabbing; }
        .widget.sortable-ghost { background: rgba(0, 122, 255, 0.1); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background: var(--tab-bg);
            color: var(--text-color);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }

        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        input, select, button {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 14px;
            background-color: var(--tab-bg);
            color: var(--text-color);
            transition: all 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

        input[type="date"] { color-scheme: dark; }
        .dark-mode input[type="date"] { color-scheme: light; }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { background: var(--primary-hover); }
        button:disabled { background: #8E8E93; cursor: not-allowed; }

        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--container-bg); color: var(--secondary-text-color); font-weight: 600; position: sticky; top: 0; text-transform: uppercase; font-size: 0.8em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: var(--tab-bg); }
        .table-wrapper { border: 1px solid var(--border-color); border-radius: var(--radius); }
        
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .pagination button { padding: 8px 12px; background: var(--container-bg); color: var(--primary-color); border: 1px solid var(--border-color); }
        .pagination button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .message { padding: 15px; border-radius: var(--radius); margin: 15px 0; font-weight: 500; }
        .message.success { background: #e6f6e9; color: #2d6b3d; border: 1px solid var(--success-color); }
        .message.error { background: #ffeeed; color: #c52a21; border: 1px solid var(--danger-color); }
        .dark-mode .message.success { background: #1c3a24; color: #a4e0b3; border: 1px solid #3c7649; }
        .dark-mode .message.error { background: #4a1c24; color: #f5c6cb; border: 1px solid #8c2f39; }

        .loading { display: none; text-align: center; padding: 40px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid var(--tab-bg); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .sensor-direction { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin: 2px; display: inline-block; }
        .direction-IN { background: var(--success-color); color: white; }
        .direction-OUT { background: var(--danger-color); color: white; }
        .direction-NA { background: var(--secondary-text-color); color: white; }
        
        .ml-section {
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: 25px;
            padding: 20px;
        }
        .ml-section h4 { font-size: 1.2em; color: var(--primary-color); margin-bottom: 10px; }
        .ml-section p { font-size: 0.95em; line-height: 1.6; }
        .placeholder-img {
            width: 100%;
            background: var(--bg-color);
            border-radius: var(--radius);
            text-align: center;
            padding: 40px 20px;
            margin-top: 15px;
            color: var(--secondary-text-color);
            font-style: italic;
        }
        
        .bar-viz {
            height: 10px;
            background: var(--primary-color);
            border-radius: 5px;
        }

        .clickable-row { cursor: pointer; }
        .hour-detail td { padding: 0 !important; border-bottom: 1px solid var(--border-color); }

        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { border-radius: 10px; }
            .header { padding: 15px; }
            .header h1 { font-size: 1.5em; }
            #uploadNewFileBtn { position: static; margin-top: 15px; display: block; width: 100%; }
            .theme-switcher { top: 15px; left: 15px; }
            .controls { flex-direction: column; align-items: stretch; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="theme-switcher" onclick="toggleTheme()">üåô</div>
            <h1>Interaktivn√≠ Data Analyz√°tor</h1>
            <p>Vylep≈°en√© vizualizace a dashboard</p>
            <button id="uploadNewFileBtn" style="display: none;">Nahr√°t nov√Ω soubor</button>
        </div>

        <div class="upload-section" id="uploadSection">
             <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ü§ñ</div>
                <h3>Nahrajte jak√Ωkoliv datov√Ω soubor</h3>
                <p><strong>Inteligentn√≠ detekce a Machine Learning</strong> - aplikace sama rozpozn√° typ dat a nab√≠dne pokroƒçil√© anal√Ωzy</p>
                <p style="margin-top: 10px; color: var(--secondary-text-color);">Podporovan√© form√°ty: XLSX, CSV, TSV, JSON, TXT</p>
                <input type="file" id="fileInput" style="display: none;" 
                       accept=".xlsx,.csv,.tsv,.json,.txt" onchange="handleFile(event)">
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Zpracov√°v√°m data...</p>
        </div>

        <div id="messageContainer"></div>

        <div class="data-section" id="dataSection">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('overview')">üìã P≈ôehled</div>
                <div class="tab" onclick="switchTab('table')">üìä Tabulka</div>
                <div class="tab" onclick="switchTab('charts')">üìà Grafy</div>
                <div class="tab" onclick="switchTab('analytics')">üîç Pokroƒçil√© anal√Ωzy</div>
                <div class="tab" onclick="switchTab('ml')">ü§ñ Machine Learning</div>
                <div class="tab" onclick="switchTab('export')">üíæ Export</div>
            </div>

            <!-- Overview -->
            <div id="overview" class="tab-content active">
                <div class="dashboard-grid" id="dashboardGrid">
                    <div class="widget" id="widget-stats">
                        <h3>Kl√≠ƒçov√© metriky</h3>
                        <div class="stats-grid" id="statsGrid"></div>
                    </div>
                    <div class="widget" id="widget-info">
                        <h3>Z√°kladn√≠ informace</h3>
                        <div id="dataInfo">Naƒç√≠t√°n√≠...</div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div id="table" class="tab-content">
                <div class="controls">
                    <input type="text" id="searchInput" placeholder="üîç Hledat..." onkeyup="applyFilters()">
                    <select id="itemsPerPage" onchange="changeItemsPerPage()"><option value="25">25</option><option value="50">50</option><option value="100">100</option></select>
                    <input type="date" id="startDate" onchange="applyFilters()">
                    <input type="date" id="endDate" onchange="applyFilters()">
                    <button onclick="exportCSV()">üìä Export tabulky</button>
                </div>
                <div class="table-container">
                    <div class="table-wrapper">
                        <table id="dataTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="pagination" id="pagination"></div>
            </div>

            <!-- Charts -->
            <div id="charts" class="tab-content">
                <div class="controls">
                    <select id="chartType" onchange="updateChartUI()"><option value="bar">üìä Sloupcov√Ω</option><option value="line">üìà ƒå√°rov√Ω</option><option value="pie">ü•ß Kol√°ƒçov√Ω</option><option value="doughnut">üç© Prstencov√Ω</option><option value="scatter">‚òÑÔ∏è Bodov√Ω</option></select>
                    <select id="xAxis" onchange="updateChart()"><option>Vyberte...</option></select>
                    <select id="yAxis" onchange="updateChart()"><option>Vyberte...</option></select>
                    <label><input type="checkbox" id="showTrendline" onchange="updateChart()"> Zobrazit trend</label>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
            
            <!-- Analytics -->
            <div id="analytics" class="tab-content"><div id="analyticsContent"></div></div>
            
            <!-- Machine Learning -->
            <div id="ml" class="tab-content">
                <div class="widget">
                    <h3>ü§ñ Machine Learning Anal√Ωzy</h3>
                    <p>Tato sekce nab√≠z√≠ pokroƒçil√© anal√Ωzy s vyu≈æit√≠m model≈Ø strojov√©ho uƒçen√≠.</p>
                </div>
                <div id="ml-content">
                    <div class="ml-section">
                        <h4>üìà Predikce trend≈Ø</h4>
                        <p>Na z√°kladƒõ historick√Ωch dat v ƒçasov√© ≈ôadƒõ model p≈ôedpov√≠ budouc√≠ v√Ωvoj.</p>
                        <div class="controls"><select id="predictionColumn"><option>Vyberte sloupec...</option></select><input type="number" value="10" min="1"><button disabled>Spustit predikci (ji≈æ brzy)</button></div>
                        <div class="placeholder-img">Zde se zobraz√≠ graf s predikovan√Ωm trendem.</div>
                    </div>
                    <div class="ml-section">
                        <h4>‚ö†Ô∏è Detekce anom√°li√≠</h4>
                        <p>Model prohled√° data a identifikuje neobvykl√© hodnoty.</p>
                         <div class="controls"><button disabled>Naj√≠t anom√°lie (ji≈æ brzy)</button></div>
                        <div class="placeholder-img">Zde se zobraz√≠ tabulka nebo vizualizace nalezen√Ωch anom√°li√≠.</div>
                    </div>
                </div>
            </div>

            <!-- Export -->
            <div id="export" class="tab-content">
                 <div class="controls">
                    <button class="btn-success" onclick="exportCSV()">üìä Export CSV</button>
                    <button class="btn-success" onclick="exportJSON()">üîó Export JSON</button>
                    <button onclick="exportPDF()">üñºÔ∏è Exportovat p≈ôehled do PDF</button>
                    <button disabled title="Tato funkce vy≈æaduje serverovou ƒç√°st.">üîó API Integrace</button>
                    <button class="btn-danger" onclick="clearAll()">üóëÔ∏è Vymazat v≈°e</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentMode = 'general', allData = [], filteredData = [], columns = [], currentPage = 1, itemsPerPage = 50, fileName = '', fileTitle = '', mainChartInstance = null, numericColumns = [], categoricalColumns = [];

        // --- Theme Manager ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            document.querySelector('.theme-switcher').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            if (mainChartInstance) updateChart();
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-switcher').textContent = '‚òÄÔ∏è';
            }
            const savedItemsPerPage = localStorage.getItem('itemsPerPage');
            if (savedItemsPerPage) {
                document.getElementById('itemsPerPage').value = savedItemsPerPage;
                itemsPerPage = parseInt(savedItemsPerPage, 10);
            }
        }

        // --- UI & Helper Functions ---
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const div = document.createElement('div');
            div.className = 'message ' + (type || 'success');
            div.textContent = message;
            container.appendChild(div);
            setTimeout(() => { if (div.parentNode) div.parentNode.removeChild(div); }, 5000);
        }

        function showLoading() { document.getElementById('loading').style.display = 'block'; }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; }

        function showDataSection() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dataSection').classList.add('active');
            document.getElementById('uploadNewFileBtn').style.display = 'block';
            new Sortable(document.getElementById('dashboardGrid'), { animation: 150, ghostClass: 'sortable-ghost' });
        }
        
        function formatHourRange(hour) {
            const startHour = String(hour).padStart(2, '0');
            const endHour = String((hour + 1) % 24).padStart(2, '0');
            return `${startHour}:00 - ${endHour}:00`;
        }

        // --- File Processing ---
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            fileName = file.name;
            showLoading();
            const extension = fileName.split('.').pop().toLowerCase();
            if (extension === 'xlsx') {
                processExcel(file);
            } else {
                processTextData(file);
            }
        }

        function processExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    processData(jsonData);
                } catch (error) {
                    showMessage(`‚ùå Chyba p≈ôi zpracov√°n√≠ Excel souboru: ${error.message}`, 'error');
                    hideLoading();
                }
            };
            reader.onerror = () => {
                showMessage('‚ùå Chyba p≈ôi ƒçten√≠ souboru', 'error');
                hideLoading();
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processTextData(file) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    if (lines.length === 0) throw new Error("Soubor je pr√°zdn√Ω.");

                    const firstLine = lines[0];
                    if (firstLine.includes(';EAN:BOX-')) { // Rohlik Sensor Data
                        const processed = [];
                        const allKeys = new Set();
                        lines.forEach(line => {
                            const row = {};
                            const parts = line.split(';');
                            const timePart = parts[0];
                            const timeMatch = timePart.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2}):(\d{3})/);
                            if (timeMatch) {
                                const [, year, month, day, hour, minute, second] = timeMatch;
                                row['timestamp'] = timePart;
                                row['datum_cas'] = `${day}.${month}.${year} ${hour}:${minute}:${second}`;
                                row['dateObject'] = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`);
                                row['hour'] = parseInt(hour, 10);
                                allKeys.add('timestamp').add('datum_cas').add('hour');
                            }
                            for (let i = 1; i < parts.length; i++) {
                                const [key, ...valueParts] = parts[i].split(':');
                                if (key) {
                                    const cleanKey = key.trim();
                                    row[cleanKey] = valueParts.join(':').trim();
                                    allKeys.add(cleanKey);
                                }
                            }
                            processed.push(row);
                        });
                        columns = Array.from(allKeys);
                        if (!columns.includes('direction')) columns.splice(6, 0, 'direction');
                        processed.forEach(row => { if (!row.hasOwnProperty('direction')) row.direction = 'N/A'; });
                        processData(processed);
                    } else { // Generic CSV/TSV
                        const separators = [';', ',', '\t'];
                        let separator = ';';
                        let maxColumns = 0;
                        
                        const lineToCheck = lines.length > 1 ? lines[1] : lines[0];
                        separators.forEach(sep => {
                            const cols = lineToCheck.split(sep).length;
                            if (cols > maxColumns) {
                                maxColumns = cols;
                                separator = sep;
                            }
                        });
                        
                        let dataStartIndex = 1;
                        if (lines.length > 1 && lines[0].split(separator).length < lines[1].split(separator).length) {
                            fileTitle = lines[0].trim().replace(/"/g, '');
                            columns = lines[1].split(separator).map(col => col.trim().replace(/"/g, ''));
                            dataStartIndex = 2;
                        } else {
                            fileTitle = '';
                            columns = lines[0].split(separator).map(col => col.trim().replace(/"/g, ''));
                        }

                        const data = [];
                        const dateColIndex = columns.findIndex(c => c.toLowerCase().includes('datum'));
                        for (let i = dataStartIndex; i < lines.length; i++) {
                            const values = lines[i].split(separator).map(v => v.trim().replace(/^"|"$/g, ''));
                            if (values.length >= columns.length) {
                                const row = {};
                                columns.forEach((col, index) => { row[col] = values[index] || ''; });
                                if (dateColIndex !== -1) {
                                    const dateStr = values[dateColIndex];
                                    const parts = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
                                    if(parts) row['dateObject'] = new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]);
                                }
                                data.push(row);
                            }
                        }
                        processData(data);
                    }
                } catch (error) {
                    showMessage(`‚ùå Chyba p≈ôi zpracov√°n√≠ souboru: ${error.message}`, 'error');
                    hideLoading();
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function processData(data) {
            allData = data.filter(row => row && Object.values(row).some(val => val != null && val !== ''));
            columns = allData.length > 0 ? Object.keys(allData[0]) : [];
            
            numericColumns = [];
            categoricalColumns = [];
            if (allData.length > 0) {
                columns.forEach(col => {
                    const isNumeric = allData.every(row => row[col] === '' || row[col] === null || !isNaN(parseFloat(row[col])));
                    if (isNumeric) numericColumns.push(col);
                    else categoricalColumns.push(col);
                });
            }

            const detectedType = detectDataType(allData, columns);
            currentMode = detectedType.type;

            hideLoading();
            showDataSection();
            showDetectionResults(detectedType);
            applyFilters();
            updateAllVisuals();
            showMessage(`‚úÖ √öspƒõ≈°nƒõ naƒçteno ${allData.length} z√°znam≈Ø - ${detectedType.description}`, 'success');
        }

        function detectDataType(data, cols) {
            if (!data || data.length === 0) return { type: 'general', description: 'Obecn√° data' };
            const refrigerationCols = ['¬∞C', 'Chlazen√≠', 'Odt√°v√°n√≠', 'Alarm'];
            if (cols.reduce((s, c) => s + (refrigerationCols.some(rc => c.includes(rc)) ? 1 : 0), 0) >= 3) return { type: 'refrigeration', description: 'Data z chlad√≠rny' };
            const sensorCols = ['timestamp', 'hour', 'sensor', 'EAN'];
            if (cols.reduce((s, c) => s + (sensorCols.includes(c) ? 1 : 0), 0) >= 3) return { type: 'sensor', description: 'Sensor Data' };
            return { type: 'general', description: 'Obecn√° data' };
        }

        function showDetectionResults(detection) {
            const messageContainer = document.getElementById('messageContainer');
            const div = document.createElement('div');
            div.className = 'message success';
            div.innerHTML = `<h4 style="margin-bottom: 5px;">ü§ñ Detekce dokonƒçena!</h4><strong>Typ dat:</strong> ${detection.description}`;
            messageContainer.insertBefore(div, messageContainer.firstChild);
            setTimeout(() => div.remove(), 8000);
        }

        function updateAllVisuals() {
            updateStats();
            updateChartUI();
            updateDataInfo();
        }

        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            let stats = [];
            if (currentMode === 'refrigeration') {
                const tempCol = columns.find(c => c.includes('¬∞C'));
                const temps = allData.map(row => parseFloat(row[tempCol])).filter(t => !isNaN(t));
                stats.push({ title: `${(temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1)}¬∞C`, subtitle: 'Pr≈Øm. teplota' });
                stats.push({ title: `${Math.min(...temps).toFixed(1)}¬∞C`, subtitle: 'Min. teplota' });
                stats.push({ title: `${Math.max(...temps).toFixed(1)}¬∞C`, subtitle: 'Max. teplota' });
                stats.push({ title: allData.filter(r => r[columns.find(c => c.toLowerCase().includes('chlazen√≠'))] === 'Aktivn√≠').length, subtitle: 'Chlad√≠c√≠ cykly' });
            } else if (currentMode === 'sensor') {
                const validData = allData.filter(d => (d.stateCode === '1' || d.Status === '1') && d.sensor !== '0');
                stats.push({ title: new Set(validData.map(d => d.EAN)).size.toLocaleString(), subtitle: 'Unik√°tn√≠ch beden' });
                stats.push({ title: new Set(validData.map(d => d.sensor)).size, subtitle: 'Aktivn√≠ch senzor≈Ø' });
            } else {
                stats.push({ title: allData.length.toLocaleString(), subtitle: 'Z√°znam≈Ø' });
                stats.push({ title: columns.length, subtitle: 'Sloupc≈Ø' });
            }
            statsGrid.innerHTML = stats.map(stat => `<div class="stat-card"><div class="stat-number">${stat.title}</div><div>${stat.subtitle}</div></div>`).join('');
        }

        function updateDataInfo() {
            const container = document.getElementById('dataInfo');
            let info = `<h4>Informace</h4><p><strong>Soubor:</strong> ${fileName}</p>`;
            if (currentMode === 'sensor') {
                 const validData = allData.filter(d => d.dateObject);
                 if (validData.length > 0) {
                    info += `<p><strong>Rozsah dat:</strong> ${validData[0].datum_cas} - ${validData[validData.length - 1].datum_cas}</p>`;
                 }
            }
            container.innerHTML = info;
        }

        function updateTable() {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            const visibleCols = columns.filter(c => c !== 'dateObject');
            tableHead.innerHTML = '<tr>' + visibleCols.map(col => `<th>${col}</th>`).join('') + '</tr>';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const pageData = filteredData.slice(startIndex, startIndex + itemsPerPage);
            tableBody.innerHTML = pageData.map(row => '<tr>' + visibleCols.map(col => `<td>${row[col] || ''}</td>`).join('') + '</tr>').join('');
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) { pagination.innerHTML = ''; return; }
            let html = '';
            if (currentPage > 1) html += `<button onclick="changePage(${currentPage - 1})">‚Üê</button>`;
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            if (currentPage < totalPages) html += `<button onclick="changePage(${currentPage + 1})">‚Üí</button>`;
            pagination.innerHTML = html;
        }

        function changePage(page) { currentPage = page; updateTable(); }
        function changeItemsPerPage() { 
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            localStorage.setItem('itemsPerPage', itemsPerPage);
            currentPage = 1; 
            updateTable(); 
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const startDate = document.getElementById('startDate').valueAsDate;
            const endDate = document.getElementById('endDate').valueAsDate;

            filteredData = allData.filter(row => {
                const textMatch = Object.values(row).some(val => val && val.toString().toLowerCase().includes(searchTerm));
                
                if (!startDate && !endDate) return textMatch;
                
                const rowDate = row.dateObject;
                if (!rowDate) return false;

                const startMatch = !startDate || rowDate >= startDate;
                const endMatch = !endDate || rowDate <= endDate;

                return textMatch && startMatch && endMatch;
            });
            currentPage = 1;
            updateTable();
        }
        
        // --- Charting ---
        function updateChartUI() {
            const chartType = document.getElementById('chartType').value;
            const xAxisSelect = document.getElementById('xAxis');
            const yAxisSelect = document.getElementById('yAxis');
            let xOptions = '', yOptions = '';

            switch(chartType) {
                case 'pie': case 'doughnut':
                    xOptions = categoricalColumns.map(c => `<option value="${c}">${c}</option>`).join('');
                    yOptions = numericColumns.map(c => `<option value="${c}">${c}</option>`).join('');
                    break;
                case 'scatter':
                    xOptions = numericColumns.map(c => `<option value="${c}">${c}</option>`).join('');
                    yOptions = numericColumns.map(c => `<option value="${c}">${c}</option>`).join('');
                    break;
                default: // bar, line
                    xOptions = categoricalColumns.map(c => `<option value="${c}">${c}</option>`).join('');
                    yOptions = numericColumns.map(c => `<option value="${c}">${c}</option>`).join('');
            }
            xAxisSelect.innerHTML = xOptions;
            yAxisSelect.innerHTML = yOptions;
            updateChart();
        }

        function calculateLinearRegression(data) {
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            const n = data.length;
            data.forEach(({x, y}) => {
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumXX += x * x;
            });
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { slope, intercept };
        }

        function updateChart() {
            const canvas = document.getElementById('mainChart');
            if (!canvas || !allData.length) return;
            const ctx = canvas.getContext('2d');
            if (mainChartInstance) mainChartInstance.destroy();

            const chartType = document.getElementById('chartType').value;
            const xCol = document.getElementById('xAxis').value;
            const yCol = document.getElementById('yAxis').value;
            if (!xCol || !yCol) return;

            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#e0e0e0' : '#333';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            let chartData, chartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: textColor } } },
                scales: { 
                    x: { ticks: { color: textColor }, grid: { color: gridColor }, title: { display: true, text: xCol, color: textColor } },
                    y: { ticks: { color: textColor }, grid: { color: gridColor }, title: { display: true, text: yCol, color: textColor } }
                }
            };
            
            let datasets = [];

            if (chartType === 'pie' || chartType === 'doughnut') {
                const grouped = allData.reduce((acc, row) => {
                    const category = row[xCol];
                    const value = parseFloat(row[yCol]);
                    if (category && !isNaN(value)) acc[category] = (acc[category] || 0) + value;
                    return acc;
                }, {});
                datasets.push({
                    label: yCol,
                    data: Object.values(grouped),
                    backgroundColor: ['#7b8ff3', '#f5576c', '#5ee7df', '#f093fb', '#ffc107', '#28a745', '#dc3545'],
                });
                chartData = { labels: Object.keys(grouped), datasets };
                chartOptions.scales = {};
            } else {
                let points = allData.map(row => ({ x: parseFloat(row[xCol]), y: parseFloat(row[yCol]) })).filter(p => !isNaN(p.x) && !isNaN(p.y));
                
                if (chartType === 'bar' || chartType === 'line') {
                    const grouped = allData.reduce((acc, row) => {
                        const category = row[xCol];
                        const value = parseFloat(row[yCol]);
                        if (category && !isNaN(value)) {
                            if (!acc[category]) acc[category] = [];
                            acc[category].push(value);
                        }
                        return acc;
                    }, {});
                    const labels = Object.keys(grouped);
                    const data = labels.map(label => grouped[label].reduce((a, b) => a + b, 0) / grouped[label].length);
                    chartData = { labels, datasets: [{ label: `Pr≈Ømƒõr ${yCol}`, data, backgroundColor: 'rgba(123, 143, 234, 0.7)', borderColor: '#7b8ff3', tension: 0.1 }] };
                } else { // scatter
                    chartData = { datasets: [{ label: `${xCol} vs ${yCol}`, data: points, backgroundColor: 'rgba(123, 143, 234, 0.7)' }] };
                }

                if (document.getElementById('showTrendline').checked && (chartType === 'scatter' || chartType === 'line')) {
                    const { slope, intercept } = calculateLinearRegression(points);
                    const minX = Math.min(...points.map(p => p.x));
                    const maxX = Math.max(...points.map(p => p.x));
                    chartData.datasets.push({
                        label: 'Trendov√° linie',
                        data: [{x: minX, y: slope * minX + intercept}, {x: maxX, y: slope * maxX + intercept}],
                        borderColor: '#f5576c',
                        backgroundColor: '#f5576c',
                        type: 'line',
                        fill: false,
                        borderDash: [5, 5]
                    });
                }
            }
            mainChartInstance = new Chart(ctx, { type: chartType, data: chartData, options: chartOptions });
        }

        // --- Specific Analysis Tabs ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'analytics') updateAdvancedAnalytics();
            else if (tabName === 'routes') updateRoutesTab();
        }

        function updateAdvancedAnalytics() {
            const container = document.getElementById('analyticsContent');
            if (currentMode === 'sensor') container.innerHTML = generateSensorAnalytics();
            else if (currentMode === 'refrigeration') container.innerHTML = generateRefrigerationAnalytics();
            else container.innerHTML = `<div style="text-align:center; padding: 40px;">Pro tento typ dat nen√≠ dostupn√° ≈æ√°dn√° pokroƒçil√° anal√Ωza.</div>`;
        }

        function generateRefrigerationAnalytics() {
            const tempCol = columns.find(c => c.includes('¬∞C'));
            const alarmCol = columns.find(c => c.toLowerCase().includes('alarm'));
            const coolingCol = columns.find(c => c.toLowerCase().includes('chlazen√≠'));
            const temps = allData.map(row => parseFloat(row[tempCol])).filter(t => !isNaN(t));
            const totalAlarms = allData.filter(r => r[alarmCol] === 'Aktivn√≠').length;
            const coolingTime = allData.filter(r => r[coolingCol] === 'Aktivn√≠').length * 5;

            return `<div class="widget"><h3>üå°Ô∏è Anal√Ωza chlad√≠rny: ${fileTitle}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div style="background: var(--bg-color); padding: 15px; border-radius: 8px;">
                        <h4>Teplotn√≠ statistiky</h4>
                        <p><strong>Pr≈Ømƒõr:</strong> ${(temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(2)}¬∞C</p>
                        <p><strong>Minimum:</strong> ${Math.min(...temps).toFixed(2)}¬∞C</p>
                        <p><strong>Maximum:</strong> ${Math.max(...temps).toFixed(2)}¬∞C</p>
                    </div>
                    <div style="background: var(--bg-color); padding: 15px; border-radius: 8px;">
                        <h4>Anal√Ωza stav≈Ø</h4>
                        <p><strong>Celkov√Ω ƒças chlazen√≠:</strong> ${Math.floor(coolingTime / 60)}h ${coolingTime % 60}m</p>
                        <p><strong>Poƒçet alarm≈Ø:</strong> <span style="color: ${totalAlarms > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">${totalAlarms}</span></p>
                    </div>
                </div>
            </div>`;
        }

        function generateSensorAnalytics() {
            const validData = allData.filter(d => (d.stateCode === '1' || d.Status === '1') && d.sensor !== '0');
            const hourlyData = {};
            validData.forEach(d => {
                if (d.hour !== undefined && d.hour !== null) {
                    hourlyData[d.hour] = (hourlyData[d.hour] || 0) + 1;
                }
            });

            const totalValid = validData.length;
            const hourlyStats = Object.entries(hourlyData).map(([hour, count]) => ({
                hour: parseInt(hour),
                count,
                percentage: (count / totalValid * 100).toFixed(1)
            })).sort((a,b) => a.hour - b.hour);

            const maxHour = hourlyStats.reduce((max, h) => h.count > max.count ? h : max, {count: -1, hour: -1});
            const minHour = hourlyStats.reduce((min, h) => h.count < min.count ? h : min, {count: Infinity, hour: -1});
            
            let summaryHtml = `<p>Nebylo nalezeno dostatek dat pro anal√Ωzu vyt√≠≈æenosti.</p>`;
            if (maxHour.hour !== -1 && minHour.hour !== -1) {
                summaryHtml = `
                    <p><strong>Celkem z√°znam≈Ø:</strong> ${allData.length} (${totalValid} validn√≠ch)</p>
                    <p><strong>Nejaktivnƒõj≈°√≠ hodina:</strong> ${formatHourRange(maxHour.hour)} (${maxHour.count} beden)</p>
                    <p><strong>Nejm√©nƒõ aktivn√≠ hodina:</strong> ${formatHourRange(minHour.hour)} (${minHour.count} beden)</p>
                    <p><strong>Doporuƒçen√≠:</strong> Provoz je nejvy≈°≈°√≠ v ${formatHourRange(maxHour.hour)}. Zva≈æte pos√≠len√≠ zdroj≈Ø v tomto ƒçase. Naopak, v ${formatHourRange(minHour.hour)} je provoz minim√°ln√≠.</p>
                `;
            }

            let html = `<div class="widget" style="margin-bottom:20px;"><h3>üìà Souhrn anal√Ωzy</h3>${summaryHtml}</div>`;
            
            html += `<div class="widget"><h3>üìã Detailn√≠ p≈ôehled</h3><div class="table-wrapper"><table class="summary-table">
                <thead><tr><th>Hodina</th><th>Poƒçet beden</th><th>Pod√≠l z celku</th><th>Vizu√°ln√≠ p≈ôehled</th></tr></thead><tbody>`;

            hourlyStats.forEach(h => {
                html += `<tr class="clickable-row" onclick="toggleHourDetail(${h.hour})">
                    <td>${formatHourRange(h.hour)}</td>
                    <td>${h.count}</td>
                    <td>${h.percentage}%</td>
                    <td><div class="bar-viz" style="width: ${h.percentage}%;"></div></td>
                </tr>
                <tr id="detail-for-hour-${h.hour}" class="hour-detail" style="display: none;"><td colspan="4"></td></tr>`;
            });

            html += `</tbody></table></div></div>`;
            return html;
        }

        function toggleHourDetail(hour) {
            const detailRow = document.getElementById(`detail-for-hour-${hour}`);
            if (!detailRow) return;

            if (detailRow.style.display === 'none') {
                if (detailRow.querySelector('td').innerHTML === '') {
                    const detailHtml = generateHourDetailHtml(hour);
                    detailRow.querySelector('td').innerHTML = detailHtml;
                }
                detailRow.style.display = 'table-row';
            } else {
                detailRow.style.display = 'none';
            }
        }

        function generateHourDetailHtml(hour) {
            const recordsForHour = allData
                .filter(row => row.hour === hour && (row.stateCode === '1' || row.Status === '1'))
                .sort((a, b) => a.timestamp.localeCompare(b.timestamp));

            if (recordsForHour.length === 0) {
                return '<p style="padding: 10px; text-align: center;">Pro tuto hodinu nebyly nalezeny ≈æ√°dn√© validn√≠ z√°znamy.</p>';
            }

            let html = `<div style="padding: 15px; background: var(--bg-color);"><table class="summary-table">
                        <thead><tr><th>P≈ôesn√Ω ƒças</th><th>EAN</th><th>Senzor</th><th>Smƒõr</th></tr></thead><tbody>`;
            
            recordsForHour.forEach(d => {
                const dirClass = d.direction === 'IN' ? 'direction-IN' : (d.direction === 'OUT' ? 'direction-OUT' : 'direction-NA');
                html += `<tr>
                    <td>${(d.datum_cas || '').split(' ')[1] || ''}</td>
                    <td>${d.EAN || ''}</td>
                    <td>${d.sensor || ''}</td>
                    <td><span class="sensor-direction ${dirClass}">${d.direction || 'N/A'}</span></td>
                 </tr>`;
            });

            html += `</tbody></table></div>`;
            return html;
        }

        function updateRoutesTab() {
            const container = document.getElementById('routesContent');
            if (currentMode !== 'sensor') {
                container.innerHTML = `<div style="text-align:center; padding: 40px;">Tato anal√Ωza je dostupn√° pouze pro Sensor data.</div>`;
                return;
            }
            
            const validData = allData.filter(d => (d.stateCode === '1' || d.Status === '1') && d.sensor !== '0' && d.timestamp).sort((a,b) => a.timestamp.localeCompare(b.timestamp));

            let html = '<div class="widget"><h3>Chronologick√Ω p≈ôehled pr≈Øchod≈Ø</h3><div class="table-wrapper"><table class="summary-table"><thead><tr><th>ƒåas</th><th>EAN</th><th>Senzor</th><th>Smƒõr</th></tr></thead><tbody>';

            validData.slice(0, 500).forEach(d => { // Limit to 500 for performance
                const dirClass = d.direction === 'IN' ? 'direction-IN' : (d.direction === 'OUT' ? 'direction-OUT' : 'direction-NA');
                html += `<tr>
                    <td>${d.datum_cas || ''}</td>
                    <td>${d.EAN || ''}</td>
                    <td>${d.sensor || ''}</td>
                    <td><span class="sensor-direction ${dirClass}">${d.direction || 'N/A'}</span></td>
                </tr>`;
            });

            html += `</tbody></table></div>`;
            if (validData.length > 500) {
                html += `<p style="text-align: center; margin-top: 10px; color: var(--secondary-text-color);">Zobrazeno prvn√≠ch 500 z√°znam≈Ø.</p>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        // --- Export & Reset ---
        function exportCSV() {
            if (filteredData.length === 0) return showMessage('‚ùå ≈Ω√°dn√° data k exportu', 'error');
            const visibleCols = columns.filter(c => c !== 'dateObject');
            let csv = visibleCols.join(',') + '\n';
            filteredData.forEach(row => {
                csv += visibleCols.map(col => `"${(row[col] || '').toString().replace(/"/g, '""')}"`).join(',') + '\n';
            });
            downloadFile(csv, `export_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv');
        }

        function exportJSON() {
            if (filteredData.length === 0) return showMessage('‚ùå ≈Ω√°dn√° data k exportu', 'error');
            const dataToExport = filteredData.map(row => {
                const newRow = {...row};
                delete newRow.dateObject;
                return newRow;
            });
            const content = JSON.stringify(dataToExport, null, 2);
            downloadFile(content, `export_${new Date().toISOString().slice(0,10)}.json`, 'application/json');
        }

        async function exportPDF() {
            showMessage('Generuji PDF report...', 'success');
            const { jsPDF } = window.jspdf;
            const dashboard = document.getElementById('dashboardGrid');
            const canvas = await html2canvas(dashboard, {
                backgroundColor: document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#ffffff',
                scale: 2
            });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            
            pdf.setFontSize(22);
            pdf.text('Report anal√Ωzy dat', pdfWidth / 2, 20, { align: 'center' });
            pdf.setFontSize(12);
            pdf.text(`Soubor: ${fileName}`, 15, 30);
            pdf.text(`Datum exportu: ${new Date().toLocaleString('cs-CZ')}`, 15, 36);

            pdf.addImage(imgData, 'PNG', 15, 45, pdfWidth - 30, pdfHeight - 30);
            
            pdf.save(`report_${fileName}.pdf`);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function resetApp() { window.location.reload(); }
        function clearAll() { if (confirm('Opravdu chcete vymazat v≈°echna data a zaƒç√≠t znovu?')) resetApp(); }
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
             applySavedTheme();
             document.getElementById('uploadNewFileBtn').addEventListener('click', resetApp);
        });
        window.addEventListener('error', e => showMessage(`‚ùå Nastala chyba: ${e.message || 'Nezn√°m√° chyba'}`, 'error'));
    </script>
</body>
</html>
